<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>2026é¦–æ—¥å°å—è¡Œï¼</title>
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°å—æ•£ç­–">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
            -webkit-tap-highlight-color: transparent;
        }
        .timeline-line::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        .map-link {
            display: inline-flex;
            align-items: center;
            background-color: #ffffff;
            color: #1d4ed8;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-top: 10px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 500;
        }
        .weather-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #billing-overlay {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
            display: flex;
            flex-direction: column;
        }
        #billing-overlay.active {
            transform: translateY(0%);
        }
        .fab-press:active { transform: scale(0.9); transition: 0.1s; }
        html, body { overflow-x: hidden; }

        /* éª¨æ¶å±èˆ‡è¼‰å…¥æ•ˆæœ */
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-orange-700 text-white pt-[calc(env(safe-area-inset-top)+20px)] pb-6 px-6 shadow-md text-center">
        <h1 class="text-xl font-bold">2026é¦–æ—¥å°å—è¡Œï¼</h1>
        <div id="user-display" class="text-[10px] opacity-80 mt-1">é€£ç·šä¸­...</div>
    </header>

    <!-- å¤©æ°£å€å¡Š -->
    <section class="mt-4 px-4">
        <div class="weather-card rounded-2xl p-5 text-white shadow-lg min-h-[160px]">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="font-bold text-lg">å°å— ä¸­è¥¿å€</h2>
                    <p class="text-xs opacity-90">1æœˆ1æ—¥ (ä¸‰) å…ƒæ—¦</p>
                </div>
                <div class="text-right">
                    <p class="text-sm" id="current-temp-main">--Â°</p>
                    <p class="text-[10px] opacity-80" id="current-pop">é™é›¨ --%</p>
                </div>
            </div>
            <div id="hourly-container" class="flex overflow-x-auto gap-3 hide-scrollbar pb-1">
                <p class="text-xs opacity-70 py-4 loading-pulse">æ­£åœ¨è¼‰å…¥æ°£è±¡è³‡æ–™...</p>
            </div>
        </div>
    </section>

    <!-- è¡Œç¨‹è·¯ç·šåœ– -->
    <main class="container mx-auto px-4 mt-6">
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-10 border border-gray-100">
            <h2 class="text-lg font-bold mb-8 flex items-center text-orange-800 border-b pb-4">
                <span class="mr-2 text-xl">ğŸš¶</span> å°å—èµ°è·³è·¯ç·š
            </h2>
            
            <div class="relative timeline-line ml-3 text-sm">
                <!-- 08:47 -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-orange-100 border-2 border-orange-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-orange-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-orange-600">08:47</span>
                    <h3 class="font-bold">æŠµé”å°å—ç«è»Šç«™</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç«è»Šç«™" target="_blank" class="map-link">ğŸ“ å°èˆªè»Šç«™</a>
                </div>

                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">08:50 - 09:05</span>
                    <p class="text-xs italic">æ²¿ä¸­å±±è·¯æ•£ç­–è‡³èˆŠåŸå€ (15 min)</p>
                </div>

                <!-- å³åœ’ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">09:05 - 10:30</span>
                    <h3 class="font-bold">å³åœ’ & å…¬æœƒå ‚</h3>
                    <p class="text-xs text-gray-500 mt-1">æ¬£è³ä¸­å¼åº­åœ’ç¾å­¸ã€‚</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—å³åœ’è—æ–‡ä¸­å¿ƒ" target="_blank" class="map-link">ğŸ“ å°èˆªå³åœ’</a>
                </div>

                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">10:30 - 10:45</span>
                    <p class="text-xs italic">æ­¥è¡Œè‡³æ¹¯å¾·ç« ç´€å¿µå…¬åœ’ (15 min)</p>
                </div>

                <!-- æ¸¬å€™æ‰€ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">10:45 - 11:45</span>
                    <h3 class="font-bold">èˆŠå¤è¹Ÿç¾¤ (æ¸¬å€™æ‰€ã€æ¶ˆé˜²é¤¨)</h3>
                    <p class="text-xs text-gray-500 mt-1">åœ°æ¨™ã€Œèƒ¡æ¤’ç®¡ã€ï¼Œæ­·å²æ ¸å¿ƒã€‚</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—æ¸¬å€™æ‰€" target="_blank" class="map-link">ğŸ“ å°èˆªæ¸¬å€™æ‰€</a>
                </div>

                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">11:45 - 12:15</span>
                    <p class="text-xs italic">æ‚ é–’æ™ƒå¾€å‹æ„›è¡— (30 min æ¢ç´¢æ™‚é–“)</p>
                </div>

                <!-- Musa -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-red-100 border-2 border-red-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-red-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-red-600">12:15 - 13:30</span>
                    <h3 class="font-bold text-red-700">Musa æ³°åœ‹æ–™ç† (åˆé¤)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Musaæ³°åœ‹æ–™ç†" target="_blank" class="map-link">ğŸ“ å°èˆª Musa</a>
                </div>

                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">13:30 - 13:45</span>
                    <p class="text-xs italic">æ­¥è¡Œå‰å¾€è¥¿å¸‚å ´ (15 min)</p>
                </div>

                <!-- è¥¿å¸‚å ´ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-blue-100 border-2 border-blue-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-blue-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-blue-600">13:45 - 14:20</span>
                    <h3 class="font-bold">è¥¿å¸‚å ´ (å¤§èœå¸‚)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—è¥¿å¸‚å ´" target="_blank" class="map-link">ğŸ“ å°èˆªè¥¿å¸‚å ´</a>
                </div>

                <!-- åœ‹è¯è¡— -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">14:25 - 16:00</span>
                    <h3 class="font-bold">åœ‹è¯è¡—ç¾é£Ÿæ¢ç´¢</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=åœ‹è¯è¡—ç¾é£Ÿ" target="_blank" class="map-link">ğŸ“ å°èˆªåœ‹è¯è¡—</a>
                </div>

                <!-- ç¾è¡“é¤¨ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-purple-100 border-2 border-purple-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-purple-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-purple-600">16:15 - 17:15</span>
                    <h3 class="font-bold">è¸ç‰›å·· & ç¾è¡“é¤¨ 2 é¤¨</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç¾è¡“é¤¨2é¤¨" target="_blank" class="map-link">ğŸ“ å°èˆªç¾é¤¨2é¤¨</a>
                </div>

                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">17:15 - 17:35</span>
                    <p class="text-xs italic">æ¼«æ­¥å›ç«è»Šç«™å€åŸŸ (20 min)</p>
                </div>

                <!-- Focus -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-yellow-100 border-2 border-yellow-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-yellow-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-yellow-600">17:35 - 18:50</span>
                    <h3 class="font-bold">Focus æ™‚å°šæµè¡Œé¤¨</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Focusæ™‚å°šæµè¡Œé¤¨" target="_blank" class="map-link">ğŸ“ å°èˆª Focus</a>
                </div>

                <div class="relative pl-10">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-gray-100 border-2 border-gray-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-gray-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-gray-600">19:15</span>
                    <h3 class="font-bold text-gray-800">è¿”å›å°å—è»Šç«™</h3>
                </div>
            </div>
        </div>
    </main>

    <!-- åˆ†å¸³æµ®çƒ -->
    <button id="fab-trigger" class="fixed bottom-8 right-6 z-50 w-16 h-16 bg-orange-600 text-white rounded-full shadow-2xl flex flex-col items-center justify-center fab-press">
        <span class="text-2xl">ğŸ’°</span>
        <span class="text-[10px] font-bold">åˆ†å¸³</span>
    </button>

    <!-- åˆ†å¸³ä»‹é¢ -->
    <div id="billing-overlay" class="fixed inset-0 z-[60] bg-gray-50 hidden overflow-y-auto">
        <header class="bg-white border-b pt-[calc(env(safe-area-inset-top)+10px)] pb-4 px-5 flex justify-between items-center sticky top-0 z-10">
            <h2 class="font-bold text-lg text-orange-700">ä¸‰äººåˆ†å¸³ç³»çµ±</h2>
            <button id="close-billing" class="text-gray-400 text-2xl p-2">âœ•</button>
        </header>

        <div class="p-4 pb-24">
            <!-- æˆ‘çš„å°ˆå±¬å ±å‘Š -->
            <div id="my-report-card" class="bg-orange-600 text-white rounded-2xl shadow-lg p-5 mb-6 hidden">
                <h3 class="text-sm font-bold mb-3 flex items-center">
                    <span class="mr-2">ğŸ“‹</span> æˆ‘çš„çµç®—å ±å‘Š
                </h3>
                <div class="space-y-2 text-sm opacity-95">
                    <p id="report-paid">ä½ ç¸½å…±å¢Šä»˜äº†ï¼š$0</p>
                    <p id="report-share">ä½ çš„æ‡‰ä»˜ä»½é¡ï¼š$0</p>
                    <div class="pt-2 border-t border-white/20">
                        <p id="report-status" class="text-base font-bold">æ­£åœ¨åŒæ­¥é›²ç«¯...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">ç¸½æ”¯å‡º</p>
                    <p id="total-amount" class="text-xl font-bold text-gray-800">$0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl shadow-sm border border-orange-100">
                    <p class="text-[10px] text-orange-600 font-bold uppercase">æ¯äººå¹³å‡</p>
                    <p id="average-amount" class="text-xl font-bold text-orange-700">$0</p>
                </div>
            </div>

            <!-- æˆå“¡ç‹€æ…‹ -->
            <div class="bg-white rounded-2xl shadow-sm border p-5 mb-6">
                <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase tracking-widest">ç›®å‰æ”¶æ”¯é¤˜é¡</h3>
                <div id="balance-list" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700">æ”¯å‡ºæ˜ç´°ç´€éŒ„</h3>
                    <button id="add-expense-btn" class="text-xs bg-orange-600 text-white px-4 py-2 rounded-full font-bold shadow-sm">+ æ–°å¢</button>
                </div>
                <div id="expense-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šç¾©ç¢ºèªåˆªé™¤å½ˆçª— -->
    <div id="confirm-modal" class="fixed inset-0 z-[150] flex items-center justify-center bg-black/60 backdrop-blur-sm px-6 hidden">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center">
            <h3 class="text-lg font-bold mb-2">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
            <p class="text-xs text-gray-400 mb-6">é€™ç­†ç´€éŒ„å°‡å¾æ‰€æœ‰äººçš„è£ç½®ä¸­ç§»é™¤ã€‚</p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
                <button id="confirm-delete" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold">åˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- èº«åˆ†é¸æ“‡ -->
    <div id="name-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/75 backdrop-blur-sm px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
            <h3 class="text-xl font-bold mb-2">ä½ æ˜¯èª°ï¼Ÿ</h3>
            <p class="text-xs text-gray-400 mb-8">é¸æ“‡å¾Œå³å¯åŒæ­¥å¸³ç›®</p>
            <div id="name-options" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <!-- æ–°å¢æ”¯å‡º -->
    <div id="expense-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/60 px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold">æ–°å¢æ”¯å‡º</h3><button id="close-expense" class="text-gray-300 p-2">âœ•</button></div>
            <div class="space-y-5">
                <input type="text" id="exp-title" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-4 outline-none" placeholder="é …ç›® (å¦‚ï¼šå°éµç¥¨)">
                <input type="number" id="exp-amount" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-4 outline-none" placeholder="é‡‘é¡">
                <button id="submit-expense" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2 fab-press">å„²å­˜ä¸¦åŒæ­¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0e7dvRxY4PAnxD1DbnA5qtBhuRvkwbYE",
            authDomain: "tainan-57cdc.firebaseapp.com",
            projectId: "tainan-57cdc",
            storageBucket: "tainan-57cdc.firebasestorage.app",
            messagingSenderId: "376439150048",
            appId: "1:376439150048:web:29c1cc89f4b9f97a7f4785",
            measurementId: "G-2Y7WP1TMWZ"
        };

        const appId = 'tainan-tour-2026';
        const FIXED_FRIENDS = ["æ˜±è¾°", "å‰å“²", "å®¸ç‘‹"];
        let db, auth, currentUser, deleteTargetId = null;
        let expenses = [];

        // å…¨åŸŸåŠŸèƒ½
        window.toggleBilling = (show) => {
            const o = document.getElementById('billing-overlay');
            if(show) { o.classList.remove('hidden'); setTimeout(() => o.classList.add('active'), 10); }
            else { o.classList.remove('active'); setTimeout(() => o.classList.add('hidden'), 400); }
        };

        window.joinSession = (name) => {
            localStorage.setItem('tainan_user_name', name);
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('user-display').innerText = `å—¨ ${name}ï¼é€£ç·šæˆåŠŸ`;
            listenToData();
        };

        window.requestDelete = (id) => {
            deleteTargetId = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        // äº‹ä»¶ç¶å®š
        document.getElementById('fab-trigger').addEventListener('click', () => window.toggleBilling(true));
        document.getElementById('close-billing').addEventListener('click', () => window.toggleBilling(false));
        document.getElementById('add-expense-btn').addEventListener('click', () => document.getElementById('expense-modal').classList.remove('hidden'));
        document.getElementById('close-expense').addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
        
        document.getElementById('confirm-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            deleteTargetId = null;
        });

        document.getElementById('confirm-delete').addEventListener('click', async () => {
            if (!db || !deleteTargetId) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', deleteTargetId));
                document.getElementById('confirm-modal').classList.add('hidden');
                deleteTargetId = null;
            } catch (e) { console.error(e); }
        });

        document.getElementById('submit-expense').addEventListener('click', async () => {
            const t = document.getElementById('exp-title').value;
            const a = document.getElementById('exp-amount').value;
            const n = localStorage.getItem('tainan_user_name');
            if(!t || !a || !db) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { 
                    title: t, amount: Number(a), userName: n, time: serverTimestamp() 
                });
                document.getElementById('exp-title').value = ''; document.getElementById('exp-amount').value = '';
                document.getElementById('expense-modal').classList.add('hidden');
            } catch (e) { console.error(e); }
        });

        // å¤©æ°£é å ±
        async function updateWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=22.9975&longitude=120.2025&hourly=temperature_2m,precipitation_probability,weather_code&timezone=Asia%2FTaipei`);
                const data = await res.json();
                const container = document.getElementById('hourly-container');
                container.innerHTML = '';
                const getEmoji = (c) => c <= 1 ? 'â˜€ï¸' : (c <= 3 ? 'ğŸŒ¤ï¸' : (c <= 65 ? 'ğŸŒ§ï¸' : 'ğŸŒ©ï¸'));
                for (let i = 6; i <= 24; i++) {
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const div = document.createElement('div');
                    div.className = "min-w-[75px] flex flex-col items-center bg-white/20 p-3 rounded-2xl backdrop-blur-sm shrink-0";
                    div.innerHTML = `<span class="text-[10px] opacity-80">${String(i).padStart(2,'0')}:00</span><span class="text-xl mb-1">${getEmoji(data.hourly.weather_code[i])}</span><span class="text-sm font-bold">${temp}Â°</span><span class="text-[8px] opacity-70">${data.hourly.precipitation_probability[i]}%</span>`;
                    container.appendChild(div);
                }
                const nowHr = new Date().getHours();
                if(nowHr >= 6 && nowHr <= 24) {
                    document.getElementById('current-temp-main').innerText = `${Math.round(data.hourly.temperature_2m[nowHr])}Â°`;
                    document.getElementById('current-pop').innerText = `é™é›¨ ${data.hourly.precipitation_probability[nowHr]}%`;
                }
            } catch (e) { console.error(e); }
        }

        function listenToData() {
            if (!db) return;
            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
            onSnapshot(ref, (snap) => {
                expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderBilling();
            });
        }

        function renderBilling() {
            const myName = localStorage.getItem('tainan_user_name');
            const total = expenses.reduce((s, e) => s + Number(e.amount), 0);
            const avg = total / 3;
            
            document.getElementById('total-amount').innerText = `$${Math.round(total)}`;
            document.getElementById('average-amount').innerText = `$${Math.round(avg)}`;

            const balances = {};
            FIXED_FRIENDS.forEach(n => balances[n] = { paid: 0, net: 0 });
            expenses.forEach(e => { if(balances[e.userName]) balances[e.userName].paid += Number(e.amount); });
            FIXED_FRIENDS.forEach(n => balances[n].net = balances[n].paid - avg);

            if (myName && balances[myName]) {
                document.getElementById('my-report-card').classList.remove('hidden');
                document.getElementById('report-paid').innerText = `ä½ ç¸½å…±å¢Šä»˜äº†ï¼š$${Math.round(balances[myName].paid)}`;
                document.getElementById('report-share').innerText = `ä½ çš„æ‡‰ä»˜ä»½é¡ï¼š$${Math.round(avg)}`;
                
                const myNet = balances[myName].net;
                const statusEl = document.getElementById('report-status');
                if (Math.abs(myNet) < 1) statusEl.innerText = "ğŸ’° ç›®å‰å¸³ç›®å·²å¹³ï¼";
                else if (myNet > 0) statusEl.innerText = `ğŸ™Œ æ‡‰æ”¶ï¼š$${Math.round(myNet)} (åˆ¥äººè©²çµ¦ä½ éŒ¢)`;
                else statusEl.innerText = `ğŸ’¸ æ‡‰ä»˜ï¼š$${Math.round(Math.abs(myNet))} (ä½ è©²çµ¦åˆ¥äººéŒ¢)`;
            }

            const balList = document.getElementById('balance-list');
            balList.innerHTML = '';
            FIXED_FRIENDS.forEach(n => {
                const mb = balances[n];
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-gray-50 rounded-xl";
                div.innerHTML = `<div class="flex items-center"><div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-700 font-bold text-xs mr-3">${n[0]}</div><span class="text-sm font-medium">${n}</span></div><span class="text-xs font-bold ${mb.net >= 0 ? 'text-green-600' : 'text-red-500'}">${mb.net >= 0 ? 'è¶…å¢Š' : 'æ¬ æ¬¾'} $${Math.round(Math.abs(mb.net))}</span>`;
                balList.appendChild(div);
            });

            const expList = document.getElementById('expense-list');
            expList.innerHTML = expenses.length ? '' : '<p class="text-center text-[10px] text-gray-300 py-8">å°šç„¡ç´€éŒ„</p>';
            [...expenses].sort((a,b) => (b.time?.seconds || 0) - (a.time?.seconds || 0)).forEach(e => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center py-4 border-b border-gray-50 last:border-0";
                div.innerHTML = `<div class="flex-1"><p class="text-sm font-bold text-gray-800">${e.title}</p><p class="text-[10px] text-gray-400">${e.userName} å¢Šä»˜</p></div><div class="flex items-center gap-4"><p class="font-bold text-gray-800">$${e.amount}</p><button onclick="window.requestDelete('${e.id}')" class="text-red-500 bg-red-50 px-3 py-1 rounded-lg text-[10px] font-bold">åˆªé™¤</button></div>`;
                expList.appendChild(div);
            });
        }

        // åˆå§‹åŒ–
        updateWeather();
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);

            const optionsContainer = document.getElementById('name-options');
            FIXED_FRIENDS.forEach(name => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-orange-50 text-orange-700 font-bold py-5 rounded-2xl active:bg-orange-600 active:text-white transition-all";
                btn.innerText = name;
                btn.onclick = () => window.joinSession(name);
                optionsContainer.appendChild(btn);
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    const saved = localStorage.getItem('tainan_user_name');
                    if (saved) {
                        document.getElementById('user-display').innerText = `å—¨ ${saved}ï¼é€£ç·šæˆåŠŸ`;
                        listenToData();
                    } else { document.getElementById('name-modal').classList.remove('hidden'); }
                }
            });
            signInAnonymously(auth);
        } catch (e) { document.getElementById('user-display').innerText = "âŒ é€£ç·šå¤±æ•—"; }
    </script>
</body>
</html>
