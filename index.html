<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å°å—æ•£ç­– 2026</title>
    
    <!-- iOS PWA è¨­å®šï¼šè®“ç¶²é æ›´åƒåŸç”Ÿ App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°å—æ•£ç­–">
    <!-- ä¸‹æ–¹å¯æ›¿æ›æˆä½ å–œæ­¡çš„ App åœ–ç¤ºé€£çµ -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
            /* æ”¯æ´ iOS å®‰å…¨å€åŸŸï¼Œé˜²æ­¢å…§å®¹è¢«ä¸‹æ–¹æ‰‹å‹¢æ¢é®ä½ */
            padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
            -webkit-tap-highlight-color: transparent;
        }
        .timeline-line::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        .map-link {
            display: inline-flex;
            align-items: center;
            background-color: #ffffff;
            color: #1d4ed8;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-top: 10px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 500;
        }
        .weather-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å´æ»‘/å½ˆå‡ºå‹•ç•«å„ªåŒ– */
        #billing-overlay {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }
        #billing-overlay.active {
            transform: translateY(0%);
        }

        .fab-press:active { transform: scale(0.9); transition: 0.1s; }
        
        /* é˜²æ­¢ iOS å½ˆæ€§æ²å‹•å°è‡´èƒŒæ™¯è·‘æ‰ */
        html, body { overflow-x: hidden; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header (é©é… iOS ç‹€æ…‹æ¬„) -->
    <header class="bg-orange-700 text-white pt-[calc(env(safe-area-inset-top)+20px)] pb-6 px-6 shadow-md text-center">
        <h1 class="text-xl font-bold">å°å—å…ƒæ—¦æ•£ç­– 1/1</h1>
        <div id="user-display" class="text-[10px] opacity-80 mt-1">é€£ç·šä¸­...</div>
    </header>

    <!-- å¤©æ°£å€å¡Š (06:00 - 24:00) -->
    <section class="mt-4 px-4">
        <div class="weather-card rounded-2xl p-5 text-white shadow-lg min-h-[160px]">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="font-bold text-lg">å°å— ä¸­è¥¿å€</h2>
                    <p class="text-xs opacity-90">1æœˆ1æ—¥ (ä¸‰) å…ƒæ—¦</p>
                </div>
                <div class="text-right">
                    <p class="text-sm" id="current-temp-main">--Â°</p>
                    <p class="text-[10px] opacity-80" id="current-pop">é™é›¨ --%</p>
                </div>
            </div>
            <div id="hourly-container" class="flex overflow-x-auto gap-3 hide-scrollbar pb-1">
                <p class="text-xs opacity-70 py-4">è¼‰å…¥å³æ™‚å¤©æ°£...</p>
            </div>
        </div>
    </section>

    <!-- è¡Œç¨‹è·¯ç·š (å®Œæ•´å…§å®¹) -->
    <main class="container mx-auto px-4 mt-6">
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-bold mb-8 flex items-center text-orange-800 border-b pb-4">
                <span class="mr-2 text-xl">ğŸš¶</span> æ•£ç­–è·¯ç·šåœ–
            </h2>
            <div class="relative timeline-line ml-3 text-sm">
                <!-- 08:47 æŠµé” -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-orange-100 border-2 border-orange-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-orange-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-orange-600">08:47</span>
                    <h3 class="font-bold">æŠµé”å°å—ç«è»Šç«™</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç«è»Šç«™" target="_blank" class="map-link">ğŸ“ å°èˆªè»Šç«™</a>
                </div>
                <!-- æ­¥è¡Œ 1 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">08:50 - 09:05</span>
                    <p class="text-xs italic">æ²¿ä¸­å±±è·¯æ•£ç­–è‡³èˆŠåŸå€ (15 min)</p>
                </div>
                <!-- å³åœ’ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">09:05 - 10:30</span>
                    <h3 class="font-bold">å³åœ’ & å…¬æœƒå ‚</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—å³åœ’" target="_blank" class="map-link">ğŸ“ å°èˆªå³åœ’</a>
                </div>
                <!-- æ­¥è¡Œ 2 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">10:30 - 10:45</span>
                    <p class="text-xs italic">æ­¥è¡Œè‡³æ¹¯å¾·ç« ç´€å¿µå…¬åœ’ (15 min)</p>
                </div>
                <!-- æ¸¬å€™æ‰€ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">10:45 - 11:45</span>
                    <h3 class="font-bold">èˆŠå¤è¹Ÿç¾¤ (æ¸¬å€™æ‰€)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—æ¸¬å€™æ‰€" target="_blank" class="map-link">ğŸ“ å°èˆªæ¸¬å€™æ‰€</a>
                </div>
                <!-- 12:15 Musa -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-red-100 border-2 border-red-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-red-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-red-600">12:15 - 13:30</span>
                    <h3 class="font-bold text-red-700">Musa æ³°åœ‹æ–™ç† (åˆé¤)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Musaæ³°åœ‹æ–™ç†" target="_blank" class="map-link">ğŸ“ å°èˆª Musa</a>
                </div>
                <!-- æ­¥è¡Œ 4 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">13:30 - 13:45</span>
                    <p class="text-xs italic">æ­¥è¡Œå‰å¾€è¥¿å¸‚å ´ (15 min)</p>
                </div>
                <!-- è¥¿å¸‚å ´ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-blue-100 border-2 border-blue-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-blue-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-blue-600">13:45 - 14:20</span>
                    <h3 class="font-bold">è¥¿å¸‚å ´ (å¤§èœå¸‚)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—è¥¿å¸‚å ´" target="_blank" class="map-link">ğŸ“ å°èˆªè¥¿å¸‚å ´</a>
                </div>
                <!-- åœ‹è¯è¡— -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">14:25 - 16:00</span>
                    <h3 class="font-bold">åœ‹è¯è¡—ç¾é£Ÿæ¢ç´¢</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=åœ‹è¯è¡—ç¾é£Ÿ" target="_blank" class="map-link">ğŸ“ å°èˆªåœ‹è¯è¡—</a>
                </div>
                <!-- ç¾è¡“é¤¨ -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-purple-100 border-2 border-purple-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-purple-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-purple-600">16:15 - 17:15</span>
                    <h3 class="font-bold">è¸ç‰›å·· & ç¾è¡“é¤¨ 2 é¤¨</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç¾è¡“é¤¨2é¤¨" target="_blank" class="map-link">ğŸ“ å°èˆªç¾é¤¨2é¤¨</a>
                </div>
                <!-- 19:15 è¿”å› -->
                <div class="relative pl-10">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-gray-100 border-2 border-gray-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-gray-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-gray-600">19:15</span>
                    <h3 class="font-bold text-gray-800">è¿”å›å°å—è»Šç«™</h3>
                </div>
            </div>
        </div>
    </main>

    <!-- åˆ†å¸³æµ®çƒ -->
    <button onclick="toggleBilling(true)" class="fixed bottom-8 right-6 z-50 w-16 h-16 bg-orange-600 text-white rounded-full shadow-2xl flex flex-col items-center justify-center fab-press">
        <span class="text-2xl">ğŸ’°</span>
        <span class="text-[10px] font-bold">åˆ†å¸³</span>
    </button>

    <!-- åˆ†å¸³å…¨è¢å¹•ä»‹é¢ (PWA å„ªåŒ–) -->
    <div id="billing-overlay" class="fixed inset-0 z-[60] bg-gray-50 flex flex-col hidden overflow-y-auto">
        <header class="bg-white border-b pt-[calc(env(safe-area-inset-top)+10px)] pb-4 px-5 flex justify-between items-center sticky top-0 z-10">
            <h2 class="font-bold text-lg text-orange-700">ä¸‰äººåˆ†å¸³ç³»çµ±</h2>
            <button onclick="toggleBilling(false)" class="text-gray-400 text-2xl p-2">âœ•</button>
        </header>

        <div class="flex-1 p-4">
            <!-- æ•¸æ“šç¸½è¦½ -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-[10px] text-gray-400 font-bold">ç¸½æ”¯å‡º</p>
                    <p id="total-amount" class="text-xl font-bold text-gray-800">$0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl shadow-sm border border-orange-100">
                    <p class="text-[10px] text-orange-600 font-bold">æ¯äººå‡åˆ†</p>
                    <p id="average-amount" class="text-xl font-bold text-orange-700">$0</p>
                </div>
            </div>

            <!-- æ ¸å¿ƒæ¸…ç®—æ¸…å–® (èª°çµ¦èª°éŒ¢) -->
            <div class="bg-white rounded-2xl shadow-md p-5 mb-6 border-t-4 border-orange-500">
                <h3 class="text-sm font-bold mb-4 flex items-center text-gray-700">
                    <span class="mr-2">ğŸ”„</span> å¯¦æ™‚è½‰å¸³æ¸…å–®
                </h3>
                <div id="transfer-list" class="space-y-3">
                    <p class="text-[11px] text-gray-400 italic">æ­£åœ¨è¨ˆç®—å¸³ç›®...</p>
                </div>
            </div>

            <!-- æ”¶æ”¯ç‹€æ…‹ -->
            <div class="bg-white rounded-2xl shadow-sm border p-5 mb-6">
                <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase tracking-widest">å€‹äººé¤˜é¡ç‹€æ…‹</h3>
                <div id="balance-list" class="space-y-3"></div>
            </div>

            <!-- æ”¯å‡ºæ˜ç´° -->
            <div class="bg-white rounded-2xl shadow-sm border p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700">æ”¯å‡ºæ˜ç´°ç´€éŒ„</h3>
                    <button onclick="openExpenseModal()" class="text-xs bg-orange-600 text-white px-4 py-2 rounded-full font-bold shadow-sm">+ æ–°å¢</button>
                </div>
                <div id="expense-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- é¸æ“‡èº«åˆ†å½ˆçª— -->
    <div id="name-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
            <h3 class="text-xl font-bold mb-2 text-gray-800">ä½ æ˜¯å“ªä½å¸¥å“¥ï¼Ÿ</h3>
            <p class="text-xs text-gray-400 mb-8">é¸æ“‡å¾Œå³å¯é–‹å•Ÿé›²ç«¯åŒæ­¥åˆ†å¸³åŠŸèƒ½</p>
            <div class="flex flex-col gap-4">
                <button onclick="joinSession('æ˜±è¾°')" class="w-full bg-orange-50 text-orange-700 font-bold py-5 rounded-2xl active:bg-orange-600 active:text-white transition-all shadow-sm">æ˜±è¾°</button>
                <button onclick="joinSession('å‰å“²')" class="w-full bg-orange-50 text-orange-700 font-bold py-5 rounded-2xl active:bg-orange-600 active:text-white transition-all shadow-sm">å‰å“²</button>
                <button onclick="joinSession('å®¸ç‘‹')" class="w-full bg-orange-50 text-orange-700 font-bold py-5 rounded-2xl active:bg-orange-600 active:text-white transition-all shadow-sm">å®¸ç‘‹</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ”¯å‡ºå½ˆçª— -->
    <div id="expense-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-black/60 px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">æ–°å¢æ”¯å‡ºé …ç›®</h3>
                <button onclick="closeExpenseModal()" class="text-gray-300 p-2">âœ•</button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">æ”¯å‡ºå…§å®¹</label>
                    <input type="text" id="exp-title" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-4 outline-none focus:border-orange-500" placeholder="ä¾‹å¦‚ï¼šå°éµç¥¨">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">ç¸½é‡‘é¡ (TWD)</label>
                    <input type="number" id="exp-amount" class="w-full bg-gray-50 border border-gray-100 rounded-xl p-4 outline-none focus:border-orange-500" placeholder="0">
                </div>
                <button onclick="submitExpense()" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2 fab-press">å„²å­˜ä¸¦åŒæ­¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // é‡è¦ï¼šå¦‚æœä½ åœ¨ GitHub ä¸ŠåŸ·è¡Œï¼Œè«‹åœ¨ä¸‹æ–¹å¡«å…¥ä½ çš„ Firebase é…ç½®
        // ==========================================
        let firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // å˜—è©¦è‡ªå‹•æŠ“å–ç’°å¢ƒè®Šæ•¸ (Canvas é è¦½ç’°å¢ƒå°ˆç”¨)
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.warn("æœªåµæ¸¬åˆ°ç’°å¢ƒè®Šæ•¸ï¼Œå°‡ä½¿ç”¨æ‰‹å‹•é…ç½®çš„ firebaseConfigã€‚");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tainan-tour-2026';

        // åˆå§‹åŒ–è®Šæ•¸
        let app, auth, db;
        const FIXED_FRIENDS = ["æ˜±è¾°", "å‰å“²", "å®¸ç‘‹"];
        let currentUser = null;
        let expenses = [];

        // å¤©æ°£åŠŸèƒ½ (ç¨ç«‹åŸ·è¡Œï¼Œä¸å— Firebase å½±éŸ¿)
        async function updateWeather() {
            const container = document.getElementById('hourly-container');
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=22.9975&longitude=120.2025&hourly=temperature_2m,precipitation_probability,weather_code&timezone=Asia%2FTaipei`);
                const data = await res.json();
                container.innerHTML = '';
                const getEmoji = (c) => c <= 1 ? 'â˜€ï¸' : (c <= 3 ? 'ğŸŒ¤ï¸' : (c <= 65 ? 'ğŸŒ§ï¸' : 'ğŸŒ©ï¸'));
                for (let i = 6; i <= 24; i++) {
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const pop = data.hourly.precipitation_probability[i];
                    const div = document.createElement('div');
                    div.className = "min-w-[75px] flex flex-col items-center bg-white/20 p-3 rounded-2xl backdrop-blur-sm shrink-0";
                    div.innerHTML = `<span class="text-[10px] opacity-80 mb-1">${String(i).padStart(2,'0')}:00</span><span class="text-xl mb-1">${getEmoji(data.hourly.weather_code[i])}</span><span class="text-sm font-bold">${temp}Â°</span><span class="text-[8px] opacity-70">${pop}%</span>`;
                    container.appendChild(div);
                    if(i === new Date().getHours()) {
                        document.getElementById('current-temp-main').innerText = `${temp}Â°`;
                        document.getElementById('current-pop').innerText = `é™é›¨ ${pop}%`;
                    }
                }
            } catch (e) { container.innerHTML = '<p class="text-xs p-4">æ°£è±¡æ›´æ–°å¤±æ•—</p>'; }
        }

        // Firebase èªè­‰èˆ‡ç›£è½
        async function initAuth() {
            if (!firebaseConfig.apiKey) {
                apiKey: "AIzaSyC0e7dvRxY4PAnxD1DbnA5qtBhuRvkwbYE",
  authDomain: "tainan-57cdc.firebaseapp.com",
  projectId: "tainan-57cdc",
  storageBucket: "tainan-57cdc.firebasestorage.app",
  messagingSenderId: "376439150048",
  appId: "1:376439150048:web:29c1cc89f4b9f97a7f4785",
  measurementId: "G-2Y7WP1TMWZ"
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        const saved = localStorage.getItem('tainan_user_name');
                        if (saved) {
                            document.getElementById('user-display').innerText = `å—¨ ${saved}ï¼é›²ç«¯åŒæ­¥ä¸­`;
                            listenToData();
                        } else { document.getElementById('name-modal').classList.remove('hidden'); }
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
            } catch (e) { 
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); 
                document.getElementById('user-display').innerText = "âŒ é›²ç«¯é€£ç·šå¤±æ•—";
            }
        }

        window.joinSession = async (name) => {
            localStorage.setItem('tainan_user_name', name);
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('user-display').innerText = `å—¨ ${name}ï¼é›²ç«¯åŒæ­¥ä¸­`;
            if (db) listenToData();
        };

        function listenToData() {
            if (!db) return;
            // ç›£è½å…¬å…±æ•¸æ“šè·¯å¾‘ï¼š/artifacts/{appId}/public/data/expenses
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snap) => {
                expenses = snap.docs.map(d => d.data());
                renderBilling();
            }, (err) => console.error("ç›£è½å¤±æ•—", err));
        }

        function renderBilling() {
            const total = expenses.reduce((s, e) => s + Number(e.amount), 0);
            const avg = total / 3;
            document.getElementById('total-amount').innerText = `$${Math.round(total)}`;
            document.getElementById('average-amount').innerText = `$${Math.round(avg)}`;

            const balances = {};
            FIXED_FRIENDS.forEach(n => balances[n] = { paid: 0, net: 0 });
            expenses.forEach(e => { if(balances[e.userName]) balances[e.userName].paid += Number(e.amount); });
            FIXED_FRIENDS.forEach(n => balances[n].net = balances[n].paid - avg);

            const balList = document.getElementById('balance-list');
            balList.innerHTML = '';
            FIXED_FRIENDS.forEach(n => {
                const mb = balances[n];
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-4 bg-gray-50 rounded-2xl";
                div.innerHTML = `<div class="flex items-center"><div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-700 font-bold text-xs mr-3">${n[0]}</div><span class="text-sm font-medium">${n}</span></div><span class="text-xs font-bold ${mb.net >= 0 ? 'text-green-600' : 'text-red-500'}">${mb.net >= 0 ? 'å·²ä»˜è¶…é¡' : 'æ¬ æ¬¾'} $${Math.round(Math.abs(mb.net))}</span>`;
                balList.appendChild(div);
            });

            const transList = document.getElementById('transfer-list');
            transList.innerHTML = '';
            let debtData = FIXED_FRIENDS.map(n => ({ name: n, net: balances[n].net }));
            let debtors = debtData.filter(b => b.net < -1).sort((a,b) => a.net - b.net);
            let creditors = debtData.filter(b => b.net > 1).sort((a,b) => b.net - a.net);

            if (!debtors.length) {
                transList.innerHTML = '<p class="text-[11px] text-gray-400 italic">ç›®å‰ç„¡è½‰å¸³éœ€æ±‚ï¼Œå¸³ç›®å·²å¹³ã€‚</p>';
            } else {
                let d=0, c=0;
                while(d < debtors.length && c < creditors.length) {
                    const transfer = Math.min(Math.abs(debtors[d].net), creditors[c].net);
                    const p = document.createElement('div');
                    p.className = "flex justify-between items-center p-3 bg-white border border-orange-50 rounded-xl shadow-sm";
                    p.innerHTML = `<span class="text-xs"><b>${debtors[d].name}</b> ğŸ‘‰ <b>${creditors[c].name}</b></span> <span class="text-orange-600 font-bold">$${Math.round(transfer)}</span>`;
                    transList.appendChild(p);
                    debtors[d].net += transfer; creditors[c].net -= transfer;
                    if(Math.abs(debtors[d].net) < 1) d++; if(Math.abs(creditors[c].net) < 1) c++;
                }
            }

            const expList = document.getElementById('expense-list');
            expList.innerHTML = expenses.length ? '' : '<p class="text-center text-[10px] text-gray-300 py-8">æš«ç„¡ç´€éŒ„</p>';
            [...expenses].sort((a,b) => (b.time?.seconds || 0) - (a.time?.seconds || 0)).forEach(e => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center py-4 border-b border-gray-50 last:border-0";
                div.innerHTML = `<div><p class="text-sm font-bold text-gray-800">${e.title}</p><p class="text-[10px] text-gray-400">ç”± ${e.userName} å¢Šä»˜</p></div><p class="font-bold text-gray-800">$${e.amount}</p>`;
                expList.appendChild(div);
            });
        }

        window.toggleBilling = (s) => {
            const o = document.getElementById('billing-overlay');
            if(s) { 
                o.classList.remove('hidden'); 
                setTimeout(() => o.classList.add('active'), 10); 
            } else { 
                o.classList.remove('active'); 
                setTimeout(() => o.classList.add('hidden'), 400); 
            }
        };
        
        window.openExpenseModal = () => document.getElementById('expense-modal').classList.remove('hidden');
        window.closeExpenseModal = () => document.getElementById('expense-modal').classList.add('hidden');
        
        window.submitExpense = async () => {
            const t = document.getElementById('exp-title').value;
            const a = document.getElementById('exp-amount').value;
            const n = localStorage.getItem('tainan_user_name');
            if(!t || !a || !db) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { 
                    title: t, 
                    amount: Number(a), 
                    userName: n, 
                    time: serverTimestamp() 
                });
                document.getElementById('exp-title').value = ''; 
                document.getElementById('exp-amount').value = ''; 
                closeExpenseModal();
            } catch (e) { 
                console.error("æäº¤å¤±æ•—", e);
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®š");
            }
        };

        // å•Ÿå‹•
        updateWeather();
        initAuth();
    </script>
</body>
</html>
