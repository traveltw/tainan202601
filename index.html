<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>2026 ä½œä¼™å°å—è¡Œ</title>
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°å—æ•£ç­–">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
            -webkit-tap-highlight-color: transparent;
        }
        .timeline-line::before {
            content: ''; position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: #e5e7eb;
        }
        .map-link {
            display: inline-flex; align-items: center; background-color: #ffffff; color: #1d4ed8; padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; margin-top: 10px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-weight: 500;
        }
        .weather-card { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æ™ºæ…§åˆ†å¸³ç³»çµ±å±¤ç´šæœ€é«˜ */
        #billing-overlay {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
            display: flex; flex-direction: column;
            z-index: 600;
        }
        #billing-overlay.active { transform: translateY(0%); }
        .fab-press:active { transform: scale(0.9); transition: 0.1s; }
        html, body { overflow-x: hidden; }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        header { position: relative; z-index: 100; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-orange-700 text-white pt-[calc(env(safe-area-inset-top)+20px)] pb-6 px-6 shadow-md text-center">
        <h1 class="text-xl font-bold">2026 ä½œä¼™å°å—è¡Œ</h1>
        <div id="user-display" class="text-[10px] opacity-80 mt-1">é€£ç·šä¸­...</div>
        
        <!-- åˆ‡æ›ä½¿ç”¨è€…æŒ‰éˆ• -->
        <button id="switch-user-btn" class="absolute right-2 top-[calc(env(safe-area-inset-top)+12px)] p-4 bg-white/10 rounded-full active:bg-white/30 transition-all border border-white/5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>
    </header>

    <!-- å¤©æ°£å€å¡Š -->
    <section class="mt-4 px-4">
        <div class="weather-card rounded-2xl p-5 text-white shadow-lg min-h-[160px]">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="font-bold text-lg">å°å— ä¸­è¥¿å€</h2>
                    <p class="text-xs opacity-90">1æœˆ1æ—¥ (ä¸‰) å…ƒæ—¦</p>
                </div>
                <div class="text-right">
                    <p class="text-sm" id="current-temp-main">--Â°</p>
                    <p class="text-[10px] opacity-80" id="current-pop">é™é›¨ --%</p>
                </div>
            </div>
            <div id="hourly-container" class="flex overflow-x-auto gap-3 hide-scrollbar pb-1">
                <p class="text-xs opacity-70 py-4 loading-pulse">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </section>

    <!-- å°å—èµ°è·³è·¯ç·š (æ¢å¾© Walking è©³ç´°è³‡è¨Š) -->
    <main class="container mx-auto px-4 mt-6">
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-10 border border-gray-100">
            <h2 class="text-lg font-bold mb-8 flex items-center text-orange-800 border-b pb-4">
                <span class="mr-2 text-xl">ğŸš¶</span> å°å—èµ°è·³è·¯ç·š
            </h2>
            
            <div class="relative timeline-line ml-3 text-sm">
                <!-- 08:47 -->
                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-orange-100 border-2 border-orange-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-orange-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-orange-600">08:47</span>
                    <h3 class="font-bold">æŠµé”å°å—ç«è»Šç«™</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç«è»Šç«™" target="_blank" class="map-link">ğŸ“ å°èˆªè»Šç«™</a>
                </div>

                <!-- æ­¥è¡Œ 1 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">08:50 - 09:05</span>
                    <p class="text-xs italic">æ²¿ä¸­å±±è·¯æ•£ç­–è‡³èˆŠåŸå€ (15 min)</p>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">09:05 - 10:30</span>
                    <h3 class="font-bold text-gray-800">å³åœ’ & å…¬æœƒå ‚</h3>
                    <p class="text-xs text-gray-500 mt-1">æ¬£è³ä¸­å¼åº­åœ’ç¾å­¸ã€‚</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—å³åœ’è—æ–‡ä¸­å¿ƒ" target="_blank" class="map-link">ğŸ“ å°èˆªå³åœ’</a>
                </div>

                <!-- æ­¥è¡Œ 2 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">10:30 - 10:45</span>
                    <p class="text-xs italic">æ­¥è¡Œè‡³æ¹¯å¾·ç« ç´€å¿µå…¬åœ’ (15 min)</p>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">10:45 - 11:45</span>
                    <h3 class="font-bold">èˆŠå¤è¹Ÿç¾¤ (æ¸¬å€™æ‰€ã€æ¶ˆé˜²é¤¨)</h3>
                    <p class="text-xs text-gray-500 mt-1">å¿…çœ‹åœ°æ¨™ã€Œèƒ¡æ¤’ç®¡ã€ã€‚</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—æ¸¬å€™æ‰€" target="_blank" class="map-link">ğŸ“ å°èˆªæ¸¬å€™æ‰€</a>
                </div>

                <!-- æ­¥è¡Œ 3 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">11:45 - 12:15</span>
                    <p class="text-xs italic">æ‚ é–’æ™ƒå¾€å‹æ„›è¡— (30 min æ¢ç´¢æ™‚é–“)</p>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-red-100 border-2 border-red-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-red-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-red-600">12:15 - 13:30</span>
                    <h3 class="font-bold text-red-700">Musa æ³°åœ‹æ–™ç† (åˆé¤)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Musaæ³°åœ‹æ–™ç†" target="_blank" class="map-link">ğŸ“ å°èˆª Musa</a>
                </div>

                <!-- æ­¥è¡Œ 4 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">13:30 - 13:45</span>
                    <p class="text-xs italic">æ­¥è¡Œå‰å¾€è¥¿å¸‚å ´ (15 min)</p>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-blue-100 border-2 border-blue-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-blue-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-blue-600">13:45 - 14:20</span>
                    <h3 class="font-bold">è¥¿å¸‚å ´ (å¤§èœå¸‚)</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—è¥¿å¸‚å ´" target="_blank" class="map-link">ğŸ“ å°èˆªè¥¿å¸‚å ´</a>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-green-100 border-2 border-green-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-green-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-green-600">14:25 - 16:00</span>
                    <h3 class="font-bold">åœ‹è¯è¡—ç¾é£Ÿæ¢ç´¢</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=åœ‹è¯è¡—ç¾é£Ÿ" target="_blank" class="map-link">ğŸ“ å°èˆªåœ‹è¯è¡—</a>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-purple-100 border-2 border-purple-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-purple-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-purple-600">16:15 - 17:15</span>
                    <h3 class="font-bold">è¸ç‰›å·· & ç¾è¡“é¤¨ 2 é¤¨</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=å°å—ç¾è¡“é¤¨2é¤¨" target="_blank" class="map-link">ğŸ“ å°èˆªç¾é¤¨2é¤¨</a>
                </div>

                <!-- æ­¥è¡Œ 5 -->
                <div class="relative pl-10 mb-8 opacity-60">
                    <div class="absolute left-1 top-2 w-4 h-4 bg-gray-200 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-500">17:15 - 17:35</span>
                    <p class="text-xs italic">æ¼«æ­¥å›ç«è»Šç«™å€åŸŸ (20 min)</p>
                </div>

                <div class="relative pl-10 mb-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-yellow-100 border-2 border-yellow-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-yellow-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-yellow-600">17:35 - 18:50</span>
                    <h3 class="font-bold">Focus æ™‚å°šæµè¡Œé¤¨</h3>
                    <a href="https://www.google.com/maps/search/?api=1&query=Focusæ™‚å°šæµè¡Œé¤¨" target="_blank" class="map-link">ğŸ“ å°èˆª Focus</a>
                </div>

                <div class="relative pl-10">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-gray-100 border-2 border-gray-500 rounded-full flex items-center justify-center"><div class="w-2 h-2 bg-gray-600 rounded-full"></div></div>
                    <span class="text-xs font-bold text-gray-600">19:15</span>
                    <h3 class="font-bold">è¿”å›å°å—è»Šç«™</h3>
                    <p class="text-xs text-gray-400 mt-1">å®Œç¾çµæŸé¦–æ—¥è¡Œç¨‹ã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <!-- åˆ†å¸³æµ®çƒ -->
    <button id="fab-trigger" class="fixed bottom-8 right-6 z-[400] w-16 h-16 bg-orange-600 text-white rounded-full shadow-2xl flex flex-col items-center justify-center fab-press">
        <span class="text-2xl">ğŸ’°</span>
        <span class="text-[10px] font-bold">åˆ†å¸³</span>
    </button>

    <!-- æ™ºæ…§åˆ†å¸³ä»‹é¢ -->
    <div id="billing-overlay" class="fixed inset-0 bg-gray-50 hidden overflow-y-auto">
        <header class="bg-white border-b pt-[calc(env(safe-area-inset-top)+10px)] pb-4 px-5 flex justify-between items-center sticky top-0 z-[510]">
            <h2 class="font-bold text-lg text-orange-700">æ™ºæ…§åˆ†å¸³ç³»çµ±</h2>
            <button id="close-billing" class="text-gray-400 text-2xl p-2">âœ•</button>
        </header>

        <div class="p-4 pb-24">
            <div id="my-report-card" class="bg-orange-600 text-white rounded-2xl shadow-lg p-5 mb-6 hidden">
                <h3 class="text-sm font-bold mb-3 flex items-center"><span class="mr-2">ğŸ“‹</span> æˆ‘çš„çµç®—å ±å‘Š</h3>
                <div class="space-y-2 text-sm opacity-95">
                    <p id="report-paid">ä½ å¢Šä»˜äº†ï¼š$0</p>
                    <p id="report-share">æ‡‰ä»˜é¡ï¼š$0</p>
                    <div class="pt-2 border-t border-white/20">
                        <p id="report-status" class="text-base font-bold text-white">åŒæ­¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border">
                    <p class="text-[10px] text-gray-400 font-bold">ç¸½æ”¯å‡º</p>
                    <p id="total-amount" class="text-xl font-bold text-gray-800">$0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl shadow-sm border border-orange-100">
                    <p class="text-[10px] text-orange-600 font-bold">å¹³å‡é¡</p>
                    <p id="average-amount" class="text-xl font-bold text-orange-700">$0</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border p-5 mb-6">
                <h3 class="text-xs font-bold mb-4 text-gray-400 uppercase text-center">çµç®—å»ºè­° (é»å°é»)</h3>
                <div id="balance-list" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700">æ”¯å‡ºæ˜ç´°ç´€éŒ„</h3>
                    <button id="add-expense-btn" class="text-xs bg-orange-600 text-white px-4 py-2 rounded-full font-bold">+ æ–°å¢</button>
                </div>
                <div id="expense-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- èº«åˆ†é¸æ“‡ (Modal) -->
    <div id="name-modal" class="fixed inset-0 z-[800] flex items-center justify-center bg-black/75 backdrop-blur-sm px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
            <h3 class="text-xl font-bold mb-2">ä½ æ˜¯å“ªä½å¸¥å“¥ï¼Ÿ</h3>
            <p class="text-xs text-gray-400 mb-8">é¸æ“‡å¾Œå³å¯é–‹å•Ÿé›²ç«¯åŒæ­¥åˆ†å¸³</p>
            <div id="name-options" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <!-- ç¢ºèªçª— -->
    <div id="confirm-modal" class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/60 backdrop-blur-sm px-6 hidden">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center">
            <h3 id="confirm-title" class="text-lg font-bold mb-2">ç¢ºå®šåŸ·è¡Œï¼Ÿ</h3>
            <p id="confirm-desc" class="text-xs text-gray-400 mb-6">æ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚</p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
                <button id="confirm-action" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ”¯å‡ºé …ç›® -->
    <div id="expense-modal" class="fixed inset-0 z-[250] flex items-center justify-center bg-black/60 px-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold">æ–°å¢æ”¯å‡º</h3><button id="close-expense" class="text-gray-300 p-2">âœ•</button></div>
            <div class="space-y-5">
                <input type="text" id="exp-title" class="w-full bg-gray-50 border rounded-xl p-4 outline-none" placeholder="é …ç›®å…§å®¹">
                <input type="number" id="exp-amount" class="w-full bg-gray-50 border rounded-xl p-4 outline-none" placeholder="é‡‘é¡">
                <button id="submit-expense" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg">å„²å­˜ä¸¦åŒæ­¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC0e7dvRxY4PAnxD1DbnA5qtBhuRvkwbYE",
            authDomain: "tainan-57cdc.firebaseapp.com",
            projectId: "tainan-57cdc",
            storageBucket: "tainan-57cdc.firebasestorage.app",
            messagingSenderId: "376439150048",
            appId: "1:376439150048:web:29c1cc89f4b9f97a7f4785",
            measurementId: "G-2Y7WP1TMWZ"
        };

        const appId = 'tainan-tour-2026';
        const FIXED_FRIENDS = ["æ˜±è¾°", "å‰å“²", "å®¸ç‘‹"];
        let db, auth, pendingAction = null, expenses = [];

        // è¼”åŠ©åŠŸèƒ½
        const formatTaipeiTime = (ts) => {
            if (!ts) return "";
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        const showConfirm = (title, desc, action) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-desc').innerText = desc;
            document.getElementById('confirm-modal').classList.remove('hidden');
            pendingAction = action;
        };

        window.toggleBilling = (show) => {
            const o = document.getElementById('billing-overlay');
            if (show) { o.classList.remove('hidden'); setTimeout(() => o.classList.add('active'), 10); }
            else { o.classList.remove('active'); setTimeout(() => o.classList.add('hidden'), 400); }
        };

        window.joinSession = (name) => {
            localStorage.setItem('tainan_user_name', name);
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('user-display').innerText = `å—¨ ${name}ï¼é€£ç·šæˆåŠŸ`;
            listenToData();
        };

        window.requestDelete = (id) => {
            showConfirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ", "ç´€éŒ„å°‡å¾é›²ç«¯å®Œå…¨ç§»é™¤ã€‚", async () => {
                if (!db) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
            });
        };

        window.switchUser = () => {
            showConfirm("æ›´æ›ä½¿ç”¨è€…èº«åˆ†ï¼Ÿ", "ç¢ºå®šå¾Œå°‡é‡æ–°é–‹å•Ÿèº«åˆ†é¸æ“‡è¦–çª—ã€‚", () => {
                localStorage.clear();
                // æ ¸å¿ƒä¿®å¾©ï¼šå…ˆé¡¯ç¤º Modalï¼Œå†å¼·åˆ¶é‡æ–°åŠ è¼‰
                document.getElementById('name-modal').classList.remove('hidden');
                document.getElementById('user-display').innerText = "é€£ç·šä¸­...";
                setTimeout(() => location.reload(), 100);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            // åˆ‡æ›æŒ‰éˆ•
            document.getElementById('switch-user-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                window.switchUser();
            });

            document.getElementById('fab-trigger')?.addEventListener('click', () => window.toggleBilling(true));
            document.getElementById('close-billing')?.addEventListener('click', () => window.toggleBilling(false));
            document.getElementById('add-expense-btn')?.addEventListener('click', () => document.getElementById('expense-modal').classList.remove('hidden'));
            document.getElementById('close-expense')?.addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
            
            document.getElementById('confirm-cancel')?.addEventListener('click', () => document.getElementById('confirm-modal').classList.add('hidden'));
            document.getElementById('confirm-action')?.addEventListener('click', async () => {
                if (pendingAction) await pendingAction();
                document.getElementById('confirm-modal').classList.add('hidden');
                pendingAction = null;
            });

            document.getElementById('submit-expense')?.addEventListener('click', async () => {
                const t = document.getElementById('exp-title')?.value;
                const a = document.getElementById('exp-amount')?.value;
                const n = localStorage.getItem('tainan_user_name');
                if(!t || !a || !db) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { title: t, amount: Number(a), userName: n, time: serverTimestamp() });
                document.getElementById('exp-title').value = ''; document.getElementById('exp-amount').value = '';
                document.getElementById('expense-modal').classList.add('hidden');
            });

            // èº«åˆ†é¸æ“‡æŒ‰éˆ•
            const optBox = document.getElementById('name-options');
            if (optBox) {
                FIXED_FRIENDS.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-orange-50 text-orange-700 font-bold py-5 rounded-2xl active:bg-orange-600 active:text-white transition-all shadow-sm";
                    btn.innerText = name;
                    btn.onclick = () => window.joinSession(name);
                    optBox.appendChild(btn);
                });
            }

            // åˆå§‹åŒ–æ™‚çš„èº«åˆ†å®ˆè¡›
            if (!localStorage.getItem('tainan_user_name')) {
                document.getElementById('name-modal').classList.remove('hidden');
            }

            updateWeather();
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const saved = localStorage.getItem('tainan_user_name');
                        if (saved) {
                            document.getElementById('user-display').innerText = `å—¨ ${saved}ï¼é€£ç·šæˆåŠŸ`;
                            listenToData();
                        } else {
                            document.getElementById('name-modal').classList.remove('hidden');
                        }
                    }
                });
                signInAnonymously(auth);
            } catch (e) { console.error(e); }
        });

        async function updateWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=22.9975&longitude=120.2025&hourly=temperature_2m,precipitation_probability,weather_code&timezone=Asia%2FTaipei`);
                const data = await res.json();
                const container = document.getElementById('hourly-container');
                if (!container) return;
                container.innerHTML = '';
                const getEmoji = (c) => c <= 1 ? 'â˜€ï¸' : (c <= 3 ? 'ğŸŒ¤ï¸' : (c <= 65 ? 'ğŸŒ§ï¸' : 'ğŸŒ©ï¸'));
                for (let i = 6; i <= 24; i++) {
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const div = document.createElement('div');
                    div.className = "min-w-[75px] flex flex-col items-center bg-white/20 p-3 rounded-2xl backdrop-blur-sm shrink-0";
                    div.innerHTML = `<span class="text-[10px] opacity-80">${String(i).padStart(2,'0')}:00</span><span class="text-xl mb-1">${getEmoji(data.hourly.weather_code[i])}</span><span class="text-sm font-bold">${temp}Â°</span><span class="text-[8px] opacity-70">${data.hourly.precipitation_probability[i]}%</span>`;
                    container.appendChild(div);
                }
                const nowHr = new Date().getHours();
                if(nowHr >= 6 && nowHr <= 24) {
                    document.getElementById('current-temp-main').innerText = `${Math.round(data.hourly.temperature_2m[nowHr])}Â°`;
                    document.getElementById('current-pop').innerText = `é™é›¨ ${data.hourly.precipitation_probability[nowHr]}%`;
                }
            } catch (e) { console.error(e); }
        }

        function listenToData() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snap) => {
                expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderBilling();
            });
        }

        function renderBilling() {
            const myName = localStorage.getItem('tainan_user_name');
            const total = expenses.reduce((s, e) => s + Number(e.amount), 0);
            const avg = total / 3;
            if (document.getElementById('total-amount')) document.getElementById('total-amount').innerText = `$${Math.round(total)}`;
            if (document.getElementById('average-amount')) document.getElementById('average-amount').innerText = `$${Math.round(avg)}`;

            const userPaid = {};
            FIXED_FRIENDS.forEach(n => userPaid[n] = 0);
            expenses.forEach(e => { if(userPaid[e.userName] !== undefined) userPaid[e.userName] += Number(e.amount); });

            if (myName) {
                document.getElementById('my-report-card')?.classList.remove('hidden');
                document.getElementById('report-paid').innerText = `ä½ å¢Šä»˜äº†ï¼š$${Math.round(userPaid[myName])}`;
                document.getElementById('report-share').innerText = `æ‡‰ä»˜é¡ï¼š$${Math.round(avg)}`;
                const myNet = userPaid[myName] - avg;
                const statusEl = document.getElementById('report-status');
                if (statusEl) {
                    if (Math.abs(myNet) < 1) statusEl.innerText = "ğŸ’° ç›®å‰å¸³ç›®å·²å¹³ï¼";
                    else if (myNet > 0) statusEl.innerText = `ğŸ™Œ æ‡‰æ”¶ç¸½é¡ï¼š$${Math.round(myNet)}`;
                    else statusEl.innerText = `ğŸ’¸ æ‡‰ä»˜ç¸½é¡ï¼š$${Math.round(Math.abs(myNet))}`;
                }

                const balList = document.getElementById('balance-list');
                if (balList) {
                    balList.innerHTML = '';
                    FIXED_FRIENDS.filter(n => n !== myName).forEach(other => {
                        const net = (userPaid[myName]/3) - (userPaid[other]/3);
                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center p-4 rounded-xl border " + (net >= 0 ? "bg-green-50 border-green-100" : "bg-red-50 border-red-100");
                        let text = Math.abs(net) < 1 ? `ä½ èˆ‡ <b>${other}</b> å¸³ç›®å·²å¹³` : (net > 0 ? `<b>${other}</b> éœ€æ”¯ä»˜çµ¦ä½ ` : `ä½  éœ€æ”¯ä»˜çµ¦ <b>${other}</b>`);
                        div.innerHTML = `<div class="flex flex-col text-xs"><span>${text}</span></div><span class="text-sm font-bold ${net >= 0 ? 'text-green-700' : 'text-red-700'}">$${Math.round(Math.abs(net))}</span>`;
                        balList.appendChild(div);
                    });
                }
            }

            const expList = document.getElementById('expense-list');
            if (expList) {
                expList.innerHTML = expenses.length ? '' : '<p class="text-center text-[10px] text-gray-300 py-8">å°šç„¡ç´€éŒ„</p>';
                [...expenses].sort((a,b) => (b.time?.seconds || 0) - (a.time?.seconds || 0)).forEach(e => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center py-4 border-b border-gray-100 last:border-0";
                    div.innerHTML = `<div class="flex-1"><p class="text-sm font-bold text-gray-800">${e.title}</p><p class="text-[10px] text-gray-400">ç”± ${e.userName} å¢Šä»˜ Â· ${e.time ? formatTaipeiTime(e.time) : "..."}</p></div><div class="flex items-center gap-4"><p class="font-bold text-gray-800">$${e.amount}</p><button onclick="window.requestDelete('${e.id}')" class="text-red-500 bg-red-50 px-3 py-1 rounded-lg text-[10px] font-bold">åˆªé™¤</button></div>`;
                    expList.appendChild(div);
                });
            }
        }
    </script>
</body>
</html>
